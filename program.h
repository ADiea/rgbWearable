#include "ws2812.h"
#include <avr/pgmspace.h>

#define DURATION(x) ((((x) & 0x1F) + 1)*(1<<(((x)>>5) & 0x7)))

#define NUM_COLS_MAX 16

typedef struct tPallette
{
	tRGB pal[NUM_COLS_MAX];
} Palette;


typedef struct tCommand
{
	unsigned char duration;
	
	unsigned char random:1;
	unsigned char randomMinMax:1;
	unsigned char reserved:1;
	unsigned char fadeToNext:1;
	unsigned char col:4;
} Command;

typedef struct tProgParams
{
	uchar curStep;
	uchar numStep;

	unsigned short curStepTime;
	unsigned short maxStepTime;

	tRGB curColor;
	tRGB nextColor;
} ProgParams;

ProgParams g_curProgram;

typedef struct tProgram
{

uchar numSteps;
Palette *pal;

Command *steps;
} Program;

Palette pal0 = {{
	{0,0,0}, {0,255,0}, {255,0,0}, {0,0,255}, 
	{255,0,255}, {0,102,255}, {0,153,255}, {0,153,102}, 
	{255,153,0}, {255,153,255}, {255,255,0}, {102,255,51},
	{0,255,255}, {204,255,51}, {153,102,51}, {255,255,255}}
	};

#define NUM_PROGS 4

/*22 steps */ 
Command stepsProg_0[] = {{4, 0, 0, 0, 1, 0}, {4, 0, 0, 0, 1, 0}, {4, 0, 0, 0, 1, 1}, {4, 0, 0, 0, 1, 15}, 
						{4, 0, 0, 0, 1, 1}, {68, 0, 0, 0, 0, 0}, {37, 0, 0, 0, 1, 0}, {36, 0, 0, 0, 1, 1}, 
						{0, 0, 0, 0, 0, 11}, {0, 0, 0, 0, 0, 10}, {0, 0, 0, 0, 0, 11}, {9, 0, 0, 0, 1, 1}, 
						{112, 0, 0, 0, 0, 0}, {37, 0, 0, 0, 1, 0}, {37, 0, 0, 0, 1, 1}, {37, 0, 0, 0, 1, 0}, 
						{37, 0, 0, 0, 1, 15}, {37, 0, 0, 0, 1, 0}, {37, 0, 0, 0, 1, 1}, {37, 0, 0, 0, 1, 15}, 
						{37, 0, 0, 0, 1, 1}, {133, 0, 0, 0, 0, 0}};


/*24 steps */ 
Command stepsProg_1[] = {{73, 0, 0, 0, 1, 0}, {73, 0, 0, 0, 1, 11}, {51, 0, 0, 0, 1, 15}, {51, 0, 0, 0, 1, 11}, 
						{73, 0, 0, 0, 1, 1}, {80, 0, 0, 0, 0, 0}, {48, 0, 0, 0, 1, 0}, {40, 0, 0, 0, 1, 15}, 
						{44, 0, 0, 0, 1, 1}, {76, 0, 0, 0, 1, 0}, {44, 0, 0, 0, 1, 1}, {44, 0, 0, 0, 1, 11}, 
						{44, 0, 0, 0, 1, 10}, {44, 0, 0, 0, 1, 15}, {76, 0, 0, 0, 1, 10}, {76, 0, 0, 0, 1, 11}, 
						{76, 0, 0, 0, 1, 1}, {44, 0, 0, 0, 1, 0}, {201, 0, 0, 0, 0, 0}, {9, 0, 0, 0, 1, 0}, 
						{9, 0, 0, 0, 1, 1}, {9, 0, 0, 0, 1, 15}, {9, 0, 0, 0, 1, 1}, {114, 0, 0, 0, 0, 0}};

/*21 steps */ 
Command stepsProg_2[] = {{11, 0, 0, 0, 1, 0}, {5, 0, 0, 0, 1, 1}, {37, 0, 0, 0, 0, 0}, {5, 0, 0, 0, 1, 1}, 
						{101, 0, 0, 0, 0, 0}, {37, 0, 0, 0, 1, 0}, {37, 0, 0, 0, 1, 15}, {37, 0, 0, 0, 1, 1}, 
						{37, 0, 0, 0, 0, 0}, {37, 0, 0, 0, 1, 0}, {37, 0, 0, 0, 1, 1}, {35, 0, 0, 0, 1, 15}, 
						{166, 0, 0, 0, 0, 0}, {6, 0, 0, 0, 1, 0}, {6, 0, 0, 0, 1, 1}, {6, 0, 0, 0, 1, 0}, 
						{6, 0, 0, 0, 1, 15}, {6, 0, 0, 0, 1, 0}, {6, 0, 0, 0, 1, 1}, {6, 0, 0, 0, 1, 0}, 
						{198, 0, 0, 0, 0, 0}};

/*25 steps */ 
Command stepsProg_3[] = {{37, 0, 0, 0, 1, 0}, {37, 0, 0, 0, 1, 14}, {37, 0, 0, 0, 1, 0}, {37, 0, 0, 0, 1, 15}, 
						{37, 0, 0, 0, 1, 14}, {101, 0, 0, 0, 0, 0}, {69, 0, 0, 0, 1, 0}, {69, 0, 0, 0, 1, 14}, 
						{69, 0, 0, 0, 1, 13}, {69, 0, 0, 0, 1, 11}, {69, 0, 0, 0, 1, 15}, {69, 0, 0, 0, 1, 11}, 
						{101, 0, 0, 0, 1, 13}, {101, 0, 0, 0, 1, 14}, {109, 0, 0, 0, 0, 0}, {72, 0, 0, 0, 1, 0}, 
						{70, 0, 0, 0, 1, 1}, {0, 0, 0, 0, 0, 0}, {98, 0, 0, 0, 1, 0}, {98, 0, 0, 0, 1, 11}, 
						{98, 0, 0, 0, 1, 0}, {98, 0, 0, 0, 1, 14}, {98, 0, 0, 0, 1, 0}, {98, 0, 0, 0, 1, 15}, 
						{142, 0, 0, 0, 0, 0}};

/*PROGMEM const*/ Program gPrograms[NUM_PROGS] = 
{
	{22, &pal0, &stepsProg_0},
	{24, &pal0, &stepsProg_1},
	{21, &pal0, &stepsProg_2},
	{25, &pal0, &stepsProg_3}
};


